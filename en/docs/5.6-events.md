## 5.6. Events

Event notification is **crucial** for attribution and measurement.

#### Best Practices

* **HTTP Persistence:** Use persistent HTTP connections (`Connection: keep-alive` in the header) to optimize performance.
* **Timeout:** Implement a timeout of 500-600ms on ad query calls to avoid harming the user experience.

#### **User and Session Identification**

* **`session_id`:** User session ID. Required in all events. Must be consistent throughout the Browse session. The session_id should be unique per user and have a lifetime of at least 14 days due to the conversion window. Ideally, the session_id should not expire. For mobile applications, the device ID should be sent as the session_id (GAID on Android and IDFA on iOS), so that the session is maintained indefinitely.
* **`user_id`:** Unique customer ID on the platform, consistent across channels. Required in the conversion event. The user_id must be the same across multiple environments such as app, website, and physical store.

#### **Impression, View, and Click Notification**

Send a `POST` request to the respective event URL (`impression_url`, `view_url`, `click_url`) provided in the ad query, with a JSON body containing `user_id` and `session_id`.

* **Content-Type:** All requests must include the `Content-Type: application/json` header.
* **Required Method (Browser):** It is **mandatory** to use `navigator.sendBeacon()` to ensure asynchronous sending without blocking navigation and prevent loss of events when the user navigates to another page or closes the browser.
* **Success Response:** `HTTP 202 Accepted`.

**Example of sending an event using Beacon API:**

```javascript
// Function to send impression event
function sendImpressionEvent(impressionUrl, userId, sessionId) {
    // Event data
    const eventData = {
        user_id: userId,
        session_id: sessionId
    };

    // Check if browser supports Beacon API
    if (navigator.sendBeacon) {
        // Convert data to JSON
        const blob = new Blob([JSON.stringify(eventData)], {type: 'application/json'});

        // Send event asynchronously
        const success = navigator.sendBeacon(impressionUrl, blob);

        if (!success) {
            console.error('Failed to send event via Beacon API');
            // Implement fallback if needed
        }
    } else {
        // Fallback for browsers that don't support Beacon API
        const xhr = new XMLHttpRequest();
        xhr.open('POST', impressionUrl, true); // true for asynchronous
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify(eventData));
    }
}

// Example usage
sendImpressionEvent(
    'https://events.newtail-media.newtail.com.br/v1/beacon/impression/123456',
    'user-123',
    'session-456'
);
```

> **Important:** Using the Beacon API is mandatory to ensure that events are sent even when the user navigates to another page or closes the browser. This prevents loss of events and ensures more accurate measurement.

#### **Conversion Notification**

When a purchase is completed, send the order data.

* **Endpoint:** `POST https://events.newtail-media.newtail.com.br/v1/beacon/conversion`
* **Content-Type:** All requests must include the `Content-Type: application/json` header.
* **Request Body:** The object must contain the order data. The item price should not be multiplied by the quantity.

| Order Field | Description | Type | Required? |
| :--- | :--- | :--- | :--- |
| `publisher_id` | Publisher ID. | String | Yes |
| `user_id` | ID of the user who made the purchase. | String | Yes |
| `session_id` | Session ID of the purchase. | String | Yes |
| `order_id` | Order ID. | String | Yes |
| `created_at` | Order date/time (ISO 8601 in UTC). | String | Yes |
| `items` | List of order items. | Array[Item] | Yes |
| `channel` | Sales channel (e.g., web, app, physical store). | String | Yes |
| `brand` | Brand/site where the sale occurred (required when there is more than one site). | String | No/Yes |
| `gender` | Indicates the customer's gender. F: for female, M: for male, O: for others, null: for unidentified. | String | No (Recommended) |
| `uf` | Indicates the state of the order purchase. | String | No (Recommended) |
| `city` | Indicates the city where the customer made the purchase. | String | No (Recommended) |
| `is_company` | Indicates if the sale was made to a company or individual. | Boolean | No (Recommended) |
| `email_hashed` | User's email in hash format (SHA256). | String | Yes |
| `phone_hashed`| User's phone in hash (SHA256). | String | No (Recommended) |
| `social_id_hashed`| User's Tax ID (CPF/CNPJ) in hash (SHA256). | String | No (Recommended) |
| `first_name_hashed` | Hashed identification of the user's First Name. | String | No (Recommended) |
| `last_name_hashed` | Hashed identification of the user's Last Name. | String | No (Recommended) |

#### **Attribution and Deduplication Rules**

* **Conversion Window:** The period after an interaction during which a sale can be attributed to the ad.
    * **Click (for `product`):** 14 days.
    * **View (for `display`/`video`):** 14 days.
* **Event Deduplication:** For the same user and ad, events are ignored for a period.
    * **Impressions:** 1 minute.
    * **Clicks:** 1 hour.
    * **Conversions:** Are not deduplicated (unless the same `order_id` is sent again within 30 days).
