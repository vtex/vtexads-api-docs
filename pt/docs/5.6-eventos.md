## 5.6. Eventos

A notifica√ß√£o de eventos √© **crucial** para a atribui√ß√£o e mensura√ß√£o.

#### Boas Pr√°ticas

*   **Persist√™ncia HTTP:** Use conex√µes HTTP persistentes (`Connection: keep-alive` no header) para otimizar a performance.
*   **Timeout (consulta de an√∫ncios):** Para chamadas de consulta de an√∫ncios (ver se√ß√£o 5.5), implemente um timeout de 500‚Äì600 ms para n√£o prejudicar a experi√™ncia do usu√°rio.

#### **Identifica√ß√£o de Usu√°rio e Sess√£o**

*   **`session_id`:** Identificador persistente do visitante. Obrigat√≥rio em todos os eventos. Deve ser consistente durante a navega√ß√£o e entre sess√µes dentro da janela de convers√£o (‚â• 14 dias). O `session_id` deve ser √∫nico por usu√°rio e, idealmente, n√£o expirar nesse per√≠odo.
*   **`user_id`:** ID √∫nico do cliente na plataforma, consistente entre canais. **Obrigat√≥rio na convers√£o**. **Opcional (recomendado)** para impress√£o, visualiza√ß√£o e clique. O `user_id` deve ser o mesmo entre app, website e loja f√≠sica.

Ap√≥s identificar o usu√°rio e a sess√£o, siga estas diretrizes para o disparo de eventos:

*   **Impress√£o (`impression_url`):** Dispare o evento imediatamente ap√≥s decidir exibir os an√∫ncios retornados pelo ad server, mesmo que o An√∫ncio acabe n√£o sendo exibido ao usu√°rio (por exemplo, devido a bloqueios ou mudan√ßas de layout).
*   **Visualiza√ß√£o (`view_url`):** Dispare o evento quando pelo menos 50% do An√∫ncio permanecer dentro do viewport do usu√°rio por 1 segundo cont√≠nuo.
*   **Clique (`click_url`):** Dispare o evento sempre que o usu√°rio clicar no An√∫ncio.

N√£o √© necess√°rio manter o estado dos eventos entre carregamentos de p√°gina, mas garanta que cada evento seja enviado apenas uma √∫nica vez para o mesmo An√∫ncio e contexto.

#### **Notifica√ß√£o de Impress√£o, Visualiza√ß√£o e Clique**

Envie uma requisi√ß√£o `POST` para a respectiva URL de evento (`impression_url`, `view_url`, `click_url`) fornecida na consulta de an√∫ncios, com um corpo JSON contendo `session_id` (**obrigat√≥rio**) e `user_id` (**quando dispon√≠vel**).

*   **Quando enviar:** `impression_url` quando o An√∫ncio for renderizado; `view_url` quando o An√∫ncio estiver vis√≠vel (se voc√™ medir viewability); `click_url` no clique do usu√°rio.
*   **URLs de eventos:** sempre use as URLs retornadas pela consulta de an√∫ncios; n√£o as derive manualmente.
*   **Content-Type:** Todas as requisi√ß√µes devem incluir o header `Content-Type: application/json`
*   **M√©todo Obrigat√≥rio (Navegador):** √â **obrigat√≥rio** usar `navigator.sendBeacon()` para garantir o envio ass√≠ncrono sem bloquear a navega√ß√£o e evitar a perda de eventos quando o usu√°rio navega para outra p√°gina ou fecha o navegador.
*   **Resposta de Sucesso:** `HTTP 202 Accepted`.

Veja exemplos de envio no navegador em `examples/EVENTS_IMPRESSIONS_VIEWS_CLICKS_BROWSER.md`.

**Exemplo de envio de evento usando Beacon API:**

```javascript
// Fun√ß√£o para enviar evento de impress√£o
function sendImpressionEvent(impressionUrl, userId, sessionId) {
    // Dados do evento
    const eventData = {
        user_id: userId,
        session_id: sessionId
    };

    // Verifica se o navegador suporta a Beacon API
    if (navigator.sendBeacon) {
        // Converte os dados para JSON
        const blob = new Blob([JSON.stringify(eventData)], {type: 'application/json'});

        // Envia o evento de forma ass√≠ncrona
        const success = navigator.sendBeacon(impressionUrl, blob);

        if (!success) {
            console.error('Falha ao enviar evento via Beacon API');
            // Implementar fallback se necess√°rio
        }
    } else {
        // Fallback para navegadores que n√£o suportam Beacon API
        const xhr = new XMLHttpRequest();
        xhr.open('POST', impressionUrl, true); // true para ass√≠ncrono
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify(eventData));
    }
}

// Exemplo de uso
sendImpressionEvent(
    'https://events.newtail-media.newtail.com.br/v1/beacon/impression/123456',
    'user-123',
    'session-456'
);
```

> **Importante:** O uso da Beacon API √© obrigat√≥rio para garantir que os eventos sejam enviados mesmo quando o usu√°rio navega para outra p√°gina ou fecha o navegador. Isso evita a perda de eventos e garante uma medi√ß√£o mais precisa.

#### **Notifica√ß√£o de Convers√£o**

Quando uma compra √© finalizada, envie os dados do pedido.

*   **Endpoint:** `POST https://events.newtail-media.newtail.com.br/v1/beacon/conversion`
*   **Content-Type:** Todas as requisi√ß√µes devem incluir o header `Content-Type: application/json`
*   **Corpo da Requisi√ß√£o:** O objeto deve conter os dados do pedido. O pre√ßo do item n√£o deve ser multiplicado pela quantidade.

Veja exemplos de convers√£o em `examples/EVENTS_CONVERSION_BROWSER.md` (Browser) e `examples/EVENTS_CONVERSION_CURL.md` (cURL).

| Campo do Pedido | Descri√ß√£o | Tipo | Obrigat√≥rio? |
| :--- | :--- | :--- | :--- |
| `publisher_id` | ID do publisher. | String | Sim |
| `user_id` | ID do usu√°rio que realizou a compra. | String | Sim |
| `session_id` | ID da sess√£o da compra. | String | Sim |
| `order_id` | ID do pedido. | String | Sim |
| `created_at` | Data/hora do pedido (ISO 8601 em UTC). | String | Sim |
| `items` | Lista de itens do pedido. | Array[Item] | Sim |
| `channel` | Canal de venda (ex.: ecommerce, app, loja f√≠sica). | String | Sim |
| `brand` | Marca/site onde ocorreu a venda (necess√°rio quando existe mais de um site). | String | N√£o/Sim |
| `gender` | Indica qual o sexo do cliente. F: para feminino, M: para masculino, O: para outros, null: para n√£o identificados. | String | N√£o (Recomendado) |
| `uf` | Indica o estado da compra do pedido. | String | N√£o (Recomendado) |
| `city` | Indica qual o nome da cidade o cliente comprou. | String | N√£o (Recomendado) |
| `is_company` | Indica se a venda foi feita para pessoa f√≠sica ou jur√≠dica. | Boolean | N√£o (Recomendado) |
| `email_hashed` | E-mail do usu√°rio em formato hash (SHA256). | String | Sim |
| `phone_hashed`| Telefone do usu√°rio em hash (SHA256). | String | N√£o (Recomendado) |
| `social_id_hashed`| CPF/CNPJ do usu√°rio em hash (SHA256). | String | N√£o (Recomendado) |
| `first_name_hashed` | Identifica√ß√£o do Primeiro Nome do usu√°rio (hash). | String | N√£o (Recomendado) |
| `last_name_hashed` | Identifica√ß√£o do √öltimo Nome do usu√°rio (hash). | String | N√£o (Recomendado) |

> Normaliza√ß√£o recomendada para hashing:
> - `email_hashed`: e-mail em lowercase e trim, sem espa√ßos extras; hash SHA-256 em hexadecimal.
> - `phone_hashed`: telefone em formato E.164 (ex.: +5511999999999), sem m√°scaras; hash SHA-256 em hexadecimal.
> - `social_id_hashed`: CPF/CNPJ somente d√≠gitos (sem pontos/tra√ßos); hash SHA-256 em hexadecimal.
> - `first_name_hashed` / `last_name_hashed`: nomes normalizados (trim, sem espa√ßos duplos); hash SHA-256 em hexadecimal.

#### **Estrutura dos Itens do Pedido**

##### Campos do Objeto Item

| Campo | Descri√ß√£o | Tipo | Obrigatoriedade |
|-------|-----------|------|-----------------|
| `sku` | Identifica√ß√£o √∫nica do SKU do produto | String | **Obrigat√≥rio** |
| `quantity` | Quantidade comprada do produto | Double | **Obrigat√≥rio** |
| `price` | Pre√ßo original do produto (pre√ßo "de") | Double | **Obrigat√≥rio** |
| `promotional_price` | Pre√ßo promocional do produto (pre√ßo "por") | Double | **Obrigat√≥rio** |
| `seller_id` | Identifica√ß√£o do vendedor/seller | String | Opcional |
| `product_id` | Identifica√ß√£o √∫nica do produto que engloba o SKU | String | Opcional |

##### ‚ö†Ô∏è Observa√ß√µes Importantes

1. **Valores unit√°rios**: Os campos `price` e `promotional_price` devem conter o valor **unit√°rio** do produto, **n√£o** multiplicado pela quantidade
2. **Campos obrigat√≥rios para mensura√ß√£o**: Se `price` e `promotional_price` n√£o forem informados corretamente, a convers√£o **n√£o poder√° ser mensurada**
3. **Formato monet√°rio**: Valores devem ser enviados como n√∫meros decimais (ex: 1899.00)

#### **Exemplos de Utiliza√ß√£o**

##### Exemplo de Item Individual
```json
{
  "sku": "12221",
  "seller_id": "1234",
  "product_id": "4567",
  "quantity": 1,
  "price": 2000.00,
  "promotional_price": 1899.00
}
```

##### Exemplo de Requisi√ß√£o Completa

```http
POST https://events.newtail-media.newtail.com.br/v1/beacon/conversion HTTP/1.1
Accept: application/json
Content-Type: application/json
```

```json
{
  "channel": "ecommerce",
  "publisher_id": "xxx",
  "user_id": "6f92d1e9-00b6-4f8b-9645-faeab321e1cc",
  "session_id": "5898b8d1-c250-4bb5-931b-8b9d0ee7b499",
  "order_id": "123",
  "email_hashed": "xyz",
  "items": [
    {
      "sku": "12221",
      "seller_id": "1234",
      "product_id": "4567",
      "quantity": 1,
      "price": 2000.00,
      "promotional_price": 1899.00
    },
    {
      "sku": "12222",
      "seller_id": null,
      "product_id": "4568",
      "quantity": 2,
      "price": 500.00,
      "promotional_price": 400.00
    }
  ],
  "created_at": "2023-01-01T09:20:00Z"
}
```

**Nota**: No exemplo acima, observe que:
- O primeiro item tem quantidade 1 com pre√ßo unit√°rio de R$ 2.000,00
- O segundo item tem quantidade 2 com pre√ßo unit√°rio de R$ 500,00 (n√£o R$ 1.000,00)

#### **Respostas da API**

##### ‚úÖ Resposta de Sucesso (HTTP 202)
```json
{
  "messages": [
    "conversion will be processed soon"
  ]
}
```

##### ‚ùå Resposta de Erro de Valida√ß√£o (HTTP 422)
A API retorna erros de valida√ß√£o em um formato compat√≠vel com JSON Schema (sem√¢ntica similar ao Ajv).

Exemplo de resposta com erros:
```json
[
  {
    "instancePath": "",
    "keyword": "required",
    "message": "must have required property 'user_id'",
    "params": {
      "missingProperty": "user_id"
    },
    "schemaPath": "#/required"
  },
  {
    "instancePath": "",
    "keyword": "required",
    "message": "must have required property 'order_id'",
    "params": {
      "missingProperty": "order_id"
    },
    "schemaPath": "#/required"
  },
  {
    "instancePath": "",
    "keyword": "required",
    "message": "must have required property 'publisher_id'",
    "params": {
      "missingProperty": "publisher_id"
    },
    "schemaPath": "#/required"
  },
  {
    "instancePath": "",
    "keyword": "required",
    "message": "must have required property 'items'",
    "params": {
      "missingProperty": "items"
    },
    "schemaPath": "#/required"
  },
  {
    "instancePath": "",
    "keyword": "required",
    "message": "must have required property 'created_at'",
    "params": {
      "missingProperty": "created_at"
    },
    "schemaPath": "#/required"
  }
]
```

#### **üéØ Regra de Match de Produtos para Convers√µes**

##### Importante: Correspond√™ncia entre Produto e Campanha

As convers√µes **s√≥ s√£o computadas** para campanhas quando ocorre um **match de produto**. Isso significa que:

- ‚úÖ **Convers√£o √© mensurada**: Quando o produto comprado pelo usu√°rio **pertence** √† campanha em que o usu√°rio foi impactado
- ‚ùå **Convers√£o N√ÉO √© mensurada**: Quando o produto comprado **n√£o pertence** √† campanha em que o usu√°rio foi impactado

##### Exemplo Pr√°tico:

**Cen√°rio 1 - Com Match (Convers√£o Computada)**
- Usu√°rio visualizou an√∫ncio da Campanha A (produtos: SKU-001, SKU-002, SKU-003)
- Usu√°rio comprou produto SKU-002
- ‚úÖ Convers√£o √© atribu√≠da √† Campanha A

**Cen√°rio 2 - Sem Match (Convers√£o N√ÉO Computada)**
- Usu√°rio visualizou an√∫ncio da Campanha B (produtos: SKU-004, SKU-005)
- Usu√°rio comprou produto SKU-999
- ‚ùå Convers√£o N√ÉO √© atribu√≠da √† Campanha B

#### **Exemplo de C√≥digo**

##### JavaScript (Browser)
```javascript
const enviarConversao = async (dadosPedido) => {
  const payload = {
    channel: "ecommerce",
    publisher_id: "xxx",
    user_id: dadosPedido.userId,
    session_id: dadosPedido.sessionId,
    order_id: dadosPedido.orderId,
    email_hashed: dadosPedido.emailHash,
    items: dadosPedido.items.map(item => ({
      sku: item.sku,
      seller_id: item.sellerId || null,
      product_id: item.productId || null,
      quantity: item.quantity,
      price: item.unitPrice,  // Valor unit√°rio, n√£o multiplicado
      promotional_price: item.unitPromotionalPrice  // Valor unit√°rio, n√£o multiplicado
    })),
    created_at: new Date().toISOString()
  };

  try {
    // Converte os dados para JSON
    const blob = new Blob([JSON.stringify(payload)], {type: 'application/json'});

    // Envia o evento de forma ass√≠ncrona usando Beacon API
    if (navigator.sendBeacon) {
      const success = navigator.sendBeacon(
        'https://events.newtail-media.newtail.com.br/v1/beacon/conversion',
        blob
      );

      if (success) {
        console.log('Convers√£o enviada com sucesso');
      } else {
        console.error('Falha ao enviar convers√£o via Beacon API');
      }
    } else {
      // Fallback para navegadores que n√£o suportam Beacon API
      const response = await fetch('https://events.newtail-media.newtail.com.br/v1/beacon/conversion', {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      if (response.status === 202) {
        console.log('Convers√£o enviada com sucesso');
      } else if (response.status === 422) {
        const errors = await response.json();
        console.error('Erros de valida√ß√£o:', errors);
      }
    }
  } catch (error) {
    console.error('Erro ao enviar convers√£o:', error);
  }
};

// Exemplo de uso
const pedido = {
  userId: "6f92d1e9-00b6-4f8b-9645-faeab321e1cc",
  sessionId: "5898b8d1-c250-4bb5-931b-8b9d0ee7b499",
  orderId: "123",
  emailHash: "xyz",
  items: [
    {
      sku: "12221",
      sellerId: "1234",
      productId: "4567",
      quantity: 1,
      unitPrice: 2000.00,
      unitPromotionalPrice: 1899.00
    }
  ]
};

enviarConversao(pedido);
```

#### **Regras de Atribui√ß√£o e Deduplica√ß√£o**

*   **Janela de Convers√£o:** Per√≠odo ap√≥s uma intera√ß√£o em que uma venda pode ser atribu√≠da ao an√∫ncio.
    *   **Click (para `product`):** 14 dias.
    *   **Visualiza√ß√£o (para `display`/`video`):** 14 dias.
*   **Deduplica√ß√£o de Eventos:** Para o mesmo usu√°rio e an√∫ncio, eventos s√£o ignorados por um per√≠odo.
    *   **Impress√µes:** 1 minuto.
    *   **Cliques:** 1 hora.
    *   **Convers√µes:** Idempotentes por `order_id` (reenvios do mesmo `order_id` em at√© 30 dias s√£o ignorados).
