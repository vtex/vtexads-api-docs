## 5.6. Eventos

A notificação de eventos é **crucial** para a atribuição e mensuração.

#### Boas Práticas

*   **Persistência HTTP:** Use conexões HTTP persistentes (`Connection: keep-alive` no header) para otimizar a performance.
*   **Timeout:** Implemente um timeout de 500-600ms nas chamadas de consulta de anúncios para não prejudicar a experiência do usuário.

#### **Identificação de Usuário e Sessão**

*   **`session_id`:** ID da sessão do usuário. Obrigatório em todos os eventos. Deve ser consistente durante a navegação. O session_id deve ser único por usuário e ter uma vida útil de pelo menos 14 dias devido à janela de conversão. O ideal é que o session_id não expire.
*   **`user_id`:** ID único do cliente na plataforma, consistente entre canais. Obrigatório no evento de conversão. O user_id deve ser o mesmo entre múltiplos ambientes como app, website e loja física.

#### **Notificação de Impressão, Visualização e Clique**

Envie uma requisição `POST` para a respectiva URL de evento (`impression_url`, `view_url`, `click_url`) fornecida na consulta de anúncios, com um corpo JSON contendo `user_id` e `session_id`.

*   **Content-Type:** Todas as requisições devem incluir o header `Content-Type: application/json`
*   **Método Obrigatório (Navegador):** É **obrigatório** usar `navigator.sendBeacon()` para garantir o envio assíncrono sem bloquear a navegação e evitar a perda de eventos quando o usuário navega para outra página ou fecha o navegador.
*   **Resposta de Sucesso:** `HTTP 202 Accepted`.

**Exemplo de envio de evento usando Beacon API:**

```javascript
// Função para enviar evento de impressão
function sendImpressionEvent(impressionUrl, userId, sessionId) {
    // Dados do evento
    const eventData = {
        user_id: userId,
        session_id: sessionId
    };

    // Verifica se o navegador suporta a Beacon API
    if (navigator.sendBeacon) {
        // Converte os dados para JSON
        const blob = new Blob([JSON.stringify(eventData)], {type: 'application/json'});

        // Envia o evento de forma assíncrona
        const success = navigator.sendBeacon(impressionUrl, blob);

        if (!success) {
            console.error('Falha ao enviar evento via Beacon API');
            // Implementar fallback se necessário
        }
    } else {
        // Fallback para navegadores que não suportam Beacon API
        const xhr = new XMLHttpRequest();
        xhr.open('POST', impressionUrl, true); // true para assíncrono
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify(eventData));
    }
}

// Exemplo de uso
sendImpressionEvent(
    'https://events.newtail-media.newtail.com.br/v1/beacon/impression/123456',
    'user-123',
    'session-456'
);
```

> **Importante:** O uso da Beacon API é obrigatório para garantir que os eventos sejam enviados mesmo quando o usuário navega para outra página ou fecha o navegador. Isso evita a perda de eventos e garante uma medição mais precisa.

#### **Notificação de Conversão**

Quando uma compra é finalizada, envie os dados do pedido.

*   **Endpoint:** `POST https://events.newtail-media.newtail.com.br/v1/beacon/conversion`
*   **Content-Type:** Todas as requisições devem incluir o header `Content-Type: application/json`
*   **Corpo da Requisição:** O objeto deve conter os dados do pedido. O preço do item não deve ser multiplicado pela quantidade.

| Campo do Pedido | Descrição | Tipo | Obrigatório? |
| :--- | :--- | :--- | :--- |
| `publisher_id` | ID do publisher. | String | Sim |
| `user_id` | ID do usuário que realizou a compra. | String | Sim |
| `session_id` | ID da sessão da compra. | String | Sim |
| `order_id` | ID do pedido. | String | Sim |
| `created_at` | Data/hora do pedido (ISO 8601 em UTC). | String | Sim |
| `items` | Lista de itens do pedido. | Array[Item] | Sim |
| `channel` | Canal de venda (ex: web, app, loja física). | String | Sim |
| `brand` | Marca/site onde ocorreu a venda (necessário quando existe mais de um site). | String | Não/Sim |
| `gender` | Indica qual o sexo do cliente. F: para feminino, M: para masculino, O: para outros, null: para não identificados. | String | Não (Recomendado) |
| `uf` | Indica o estado da compra do pedido. | String | Não (Recomendado) |
| `city` | Indica qual o nome da cidade o cliente comprou. | String | Não (Recomendado) |
| `is_company` | Indica se a venda foi feita para pessoa física ou jurídica. | Boolean | Não (Recomendado) |
| `email_hashed` | E-mail do usuário em formato hash (SHA256). | String | Sim |
| `phone_hashed`| Telefone do usuário em hash (SHA256). | String | Não (Recomendado) |
| `social_id_hashed`| CPF/CNPJ do usuário em hash (SHA256). | String | Não (Recomendado) |
| `first_name_hashed` | Identificação do Primeiro Nome do usuário "Hasheado". | String | Não (Recomendado) |
| `last_name_hashed` | Identificação do Último Nome do usuário "Hasheado". | String | Não (Recomendado) |

#### **Regras de Atribuição e Deduplicação**

*   **Janela de Conversão:** Período após uma interação em que uma venda pode ser atribuída ao anúncio.
    *   **Click (para `product`):** 14 dias.
    *   **Visualização (para `display`/`video`):** 14 dias.
*   **Deduplicação de Eventos:** Para o mesmo usuário e anúncio, eventos são ignorados por um período.
    *   **Impressões:** 1 minuto.
    *   **Cliques:** 1 hora.
    *   **Conversões:** Não são deduplicadas (exceto se o mesmo `order_id` for enviado novamente em até 30 dias).
