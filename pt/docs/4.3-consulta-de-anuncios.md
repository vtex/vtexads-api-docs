## 4.2. Consulta de Anúncios

Com o catálogo sincronizado, sua plataforma requisita anúncios para preencher os espaços publicitários (`placements`). A requisição é um `POST` e o `publisher_id` deve ser informado na URL.

*   **Endpoint:** `POST https://newtail-media.newtail.com.br/v1/rma/:publisher_id`
*   **Content-Type:** Todas as requisições devem incluir o header `Content-Type: application/json`

#### **Parâmetros da Requisição**

| Campo | Descrição | Tipo | Obrigatoriedade |
| :--- | :--- | :--- | :--- |
| `session_id` | ID único da sessão do usuário (alfanumérico). | String | Sim |
| `user_id` | ID único do usuário logado (alfanumérico). | String | Não |
| `store_id` | Filtra anúncios por estoque de uma loja específica. | String | Não |
| `channel` | Canal de acesso: `site`, `msite`, `app`. | String | Sim |
| `context` | Contexto: `home`, `category`, `search`, `product_page`, `brand_page`, `digital_signage`.| String | Sim |
| `term` | Termo buscado pelo usuário. | String | Apenas `context: 'search'` |
| `category_name` | Categoria navegada (breadcrumb completo).| String | Apenas `context: 'category'`|
| `product_sku` | SKU do produto sendo visualizado. | String | Apenas `context: 'product_page'` |
| `brand_name` | Nome da marca sendo visualizada. | String | Apenas `context: 'brand_page'` |
| `device_id` | ID único do dispositivo (tela, totem). | String | Apenas `context: 'digital_signage'` |
| `store_name` | Nome da loja onde o dispositivo está localizado. | String | Apenas `context: 'digital_signage'` |
| `placements` | Objeto que define os espaços (`placements`) de anúncio. | Object | Sim |
| `placements.{name}.quantity` | Quantidade de anúncios desejada. | Integer | Sim |
| `placements.{name}.size` | Tamanho esperado (ex: `desktop` para imagens, `720p` para vídeos). | String | Apenas `types: ['banner', 'sponsored_brand']` |
| `placements.{name}.types` | Tipos permitidos (`product`, `banner`, etc.). | Array[String] | Sim |
| `placements.{name}.assets_type`| Mídias aceitas (`image`, `video`). Padrão: `["image"]`. | Array[String] | Apenas `types: ['banner', 'sponsored_brand']` |
| `placements.{name}.allow_sku_duplications` | Permite que anúncios de mesmo SKU possam ser retornados para um mesmo placement. | Boolean | Não (Default=false) |
| `userAgent` | String de identificação do ambiente do cliente. | String | Não |
| `segmentation` | Dados para segmentação em tempo real. | Array[Object] | Não |
| `segmentation.#.key` | O tipo de segmentação. | String | Não |
| `segmentation.#.values` | Array de valores para a segmentação. | Array[String] | Não |
| `tags` | "Etiquetas" para contextualizar buscas. Máx. 10 por SKU, 64 chars por tag. Apenas para campanhas de `product`. | Array[String] | Não |
| `brand` | Nome do site do publisher. | String | Obrigatório quando o publisher possui mais de um site |
| `dedup_campaign_ads` | Define se os resultados devem ser deduplicados por campanha. Ou seja, a resposta conterá no máximo um anúncio por campanha. | Boolean | Não (Default=false) |
| `dedup_ads` | Define se os resultados devem ser deduplicados os ads em multiplos placements (usar apenas quando consultar multiplos placements ao menos tempo). | Boolean | Não (Default=false) |

#### **Resposta da Consulta**
A resposta é um JSON onde cada chave é um nome de `placement`. Para anúncios do tipo `sponsored_brand` e `digital_signage`, a estrutura interna varia (ver seções específicas).

| Campo na Resposta (`product`, `banner`) | Descrição |
| :--- | :--- |
| `{placementName}.#.ad_id` | ID único do anúncio. |
| `{placementName}.#.type` | Tipo do anúncio (`banner`, `product`). |
| `{placementName}.#.media_url`| URL da imagem ou vídeo a ser exibido. |
| `{placementName}.#.click_url`| **URL para notificar o evento de clique.** |
| `{placementName}.#.impression_url`| **URL para notificar o evento de impressão.**|
| `{placementName}.#.view_url` | **URL para notificar o evento de visualização.** |
| `{placementName}.#.product_sku`| SKU (para anúncios do tipo `product`). |

### Boas Práticas

#### Nomenclatura de Placements

Adote um padrão claro, como `{canal}_{contexto}_{posicao}_{tipo}` (ex: `msite_search_top-shelf_product`).

| canal | contexto | posição | tipo | exemplo |
| --- | --- | --- | --- | --- |
| site | home | middle | banner | site_home_middle_banner |
| msite | product | top-vitrine | product | msite_product_top-vitrine_product |
| app | search | top-vitrine | product | app_search_top-vitrine_product |
| app | search | top-vitrine | banner | app_search_top-vitrine_banner |
| site | category | bottom-vitrine | banner | site_category_bottom-vitrine_banner |
| site | product | filter-bar | product | site_product_filter-bar_product |

#### Tamanhos de Imagem Padrão IAB

Para anúncios do tipo banner, é importante utilizar imagens nos formatos padrão definidos pelo IAB (Interactive Advertising Bureau). Isso garante a compatibilidade e uma melhor experiência visual em diferentes sites e dispositivos.

**Formatos Principais:**

*   **Retângulo Médio:** 300x250 pixels
*   **Leaderboard:** 728x90 pixels
*   **Skyscraper Largo:** 160x600 pixels
*   **Leaderboard Móvel:** 320x50 pixels
*   **Billboard:** 970x250 pixels
*   **Meia Página:** 300x600 pixels

#### Opções de Tamanho para Vídeos

Para solicitações de anúncios de vídeo, você deve especificar o parâmetro de tamanho para filtrar por resolução de vídeo. As opções disponíveis são:

*   **1080p** (1920x1080 pixels) - Recomendado apenas para vídeos em tela cheia
*   **720p** (1280x720 pixels) - Recomendado apenas para vídeos em tela cheia
*   **480p** (854x480 pixels)
*   **360p** (640x360 pixels)
*   **320p** (568x320 pixels) - Recomendado para dispositivos móveis

**Importante:** Ao solicitar anúncios de vídeo, use apenas o identificador de resolução (ex: `"720p"`) no parâmetro size, não as dimensões completas. Por exemplo, para filtrar por resolução 1280x720, use `"size": "720p"` na sua solicitação de anúncio.

### Segmentação de Anúncios

Direcione anúncios para públicos específicos para aumentar a relevância.

#### **Segmentação em Tempo Real**
Envie dados demográficos ou de audiência diretamente no corpo da **consulta de anúncios**, no campo `segmentation`.

O campo `segmentation` é um array de objetos, onde cada objeto contém:
- `key`: O tipo de segmentação (ex: "STATE", "CITY", "GENDER")
- `values`: Array de valores para a segmentação

**Exemplo de Segmentação:**

```json
[
    {
        "key": "STATE",
        "values": [
            "RJ"
        ]
    },
    {
        "key": "CITY",
        "values": [
            "Rio de Janeiro"
        ]
    }
]
```

**Tipos de Segmentação Disponíveis:**

| Chave (key) | Descrição | Exemplo de Valores |
| :--- | :--- | :--- |
| `STATE` | Estado do usuário | "SP", "RJ", "MG" |
| `CITY` | Cidade do usuário | "São Paulo", "Rio de Janeiro" |
| `GENDER` | Gênero do usuário | "M", "F" |
| `AGE` | Idade do usuário | "22", "35" |
| `AUDIENCES` | Audiência personalizada | "high_value_customers", "cart_abandoners" |
| `NBO_CATEGORIES` | Indica quais as possíveis categorias que o usuário tem intenção de comprar | "Eletrônicos", "Livros" |
