## 5.6. Eventos

La notificaci√≥n de eventos es **crucial** para la atribuci√≥n y la medici√≥n.

#### Buenas Pr√°cticas

* **Persistencia HTTP:** Utilice conexiones HTTP persistentes (`Connection: keep-alive` en el encabezado) para optimizar la performance.
* **Timeout (consulta de anuncios):** Para llamadas de consulta de anuncios (ver secci√≥n 5.5), implemente un timeout de 500‚Äì600 ms para no perjudicar la experiencia del usuario.

#### **Identificaci√≥n de Usuario y Sesi√≥n**

* **`session_id`:** Identificador persistente del visitante. Obligatorio en todos los eventos. Debe mantenerse consistente durante la navegaci√≥n y entre sesiones dentro de la ventana de conversi√≥n (‚â• 14 d√≠as). El `session_id` debe ser √∫nico por usuario y, idealmente, no expirar en este per√≠odo.
* **`user_id`:** ID √∫nico del cliente en la plataforma, consistente entre canales. **Obligatorio en conversi√≥n**. **Opcional (recomendado)** para impresi√≥n, visualizaci√≥n y clic. El `user_id` debe ser el mismo entre app, sitio web y tienda f√≠sica.

#### **Notificaci√≥n de Impresi√≥n, Visualizaci√≥n y Clic**

Env√≠e una solicitud `POST` a la respectiva URL de evento (`impression_url`, `view_url`, `click_url`) proporcionada en la consulta de anuncios, con un cuerpo JSON que contenga `session_id` (**obligatorio**) y `user_id` (**cuando est√© disponible**).

* **Cu√°ndo enviar:** `impression_url` cuando se renderiza el creativo; `view_url` cuando el creativo est√© visible (si usted mide viewability); `click_url` en el clic del usuario.
* **URLs de eventos:** utilice siempre las URLs de evento provistas por la consulta de anuncios; no las derive manualmente.
* **Content-Type:** Todas las solicitudes deben incluir el encabezado `Content-Type: application/json`
* **M√©todo Obligatorio (Navegador):** Es **obligatorio** usar `navigator.sendBeacon()` para garantizar el env√≠o as√≠ncrono sin bloquear la navegaci√≥n y evitar la p√©rdida de eventos cuando el usuario navega a otra p√°gina o cierra el navegador.
* **Respuesta Exitosa:** `HTTP 202 Accepted`.

Consulte ejemplos de env√≠o desde el navegador en `examples/EVENTS_IMPRESSIONS_VIEWS_CLICKS_BROWSER.md`.

**Ejemplo de env√≠o de evento usando Beacon API:**

```javascript
// Funci√≥n para enviar evento de impresi√≥n
function sendImpressionEvent(impressionUrl, userId, sessionId) {
    // Datos del evento
    const eventData = {
        user_id: userId,
        session_id: sessionId
    };

    // Verifica si el navegador soporta la Beacon API
    if (navigator.sendBeacon) {
        // Convierte los datos a JSON
        const blob = new Blob([JSON.stringify(eventData)], {type: 'application/json'});

        // Env√≠a el evento de forma as√≠ncrona
        const success = navigator.sendBeacon(impressionUrl, blob);

        if (!success) {
            console.error('Error al enviar evento v√≠a Beacon API');
            // Implementar fallback si es necesario
        }
    } else {
        // Fallback para navegadores que no soportan Beacon API
        const xhr = new XMLHttpRequest();
        xhr.open('POST', impressionUrl, true); // true para as√≠ncrono
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify(eventData));
    }
}

// Ejemplo de uso
sendImpressionEvent(
    'https://events.newtail-media.newtail.com.br/v1/beacon/impression/123456',
    'user-123',
    'session-456'
);
```

> **Importante:** El uso de la Beacon API es obligatorio para garantizar que los eventos se env√≠en incluso cuando el usuario navega a otra p√°gina o cierra el navegador. Esto evita la p√©rdida de eventos y asegura una medici√≥n m√°s precisa.

#### **Notificaci√≥n de Conversi√≥n**

Cuando una compra es finalizada, env√≠e los datos del pedido.

* **Endpoint:** `POST https://events.newtail-media.newtail.com.br/v1/beacon/conversion`
* **Content-Type:** Todas las solicitudes deben incluir el encabezado `Content-Type: application/json`
* **Cuerpo de la Solicitud:** El objeto debe contener los datos del pedido. El precio del art√≠culo no debe ser multiplicado por la cantidad.

Consulte ejemplos de conversi√≥n en `examples/EVENTS_CONVERSION_BROWSER.md` (Browser) y `examples/EVENTS_CONVERSION_CURL.md` (cURL).

| Campo del Pedido | Descripci√≥n | Tipo | ¬øObligatorio? |
| :--- | :--- | :--- | :--- |
| `publisher_id` | ID del publisher. | String | S√≠ |
| `user_id` | ID del usuario que realiz√≥ la compra. | String | S√≠ |
| `session_id` | ID de la sesi√≥n de la compra. | String | S√≠ |
| `order_id` | ID del pedido. | String | S√≠ |
| `created_at` | Fecha/hora del pedido (ISO 8601 en UTC). | String | S√≠ |
| `items` | Lista de art√≠culos del pedido. | Array[Item] | S√≠ |
| `channel` | Canal de venta (ej.: ecommerce, app, tienda f√≠sica). | String | S√≠ |
| `brand` | Marca/sitio donde ocurri√≥ la venta (necesario cuando existe m√°s de un sitio). | String | No/S√≠ |
| `gender` | Indica el g√©nero del cliente. F: para femenino, M: para masculino, O: para otros, null: para no identificados. | String | No (Recomendado) |
| `uf` | Indica el estado de la compra del pedido. | String | No (Recomendado) |
| `city` | Indica el nombre de la ciudad donde el cliente realiz√≥ la compra. | String | No (Recomendado) |
| `is_company` | Indica si la venta fue realizada a una persona jur√≠dica o f√≠sica. | Boolean | No (Recomendado) |
| `email_hashed` | E-mail del usuario en formato hash (SHA256). | String | S√≠ |
| `phone_hashed`| Tel√©fono del usuario en hash (SHA256). | String | No (Recomendado) |
| `social_id_hashed`| ID social/fiscal del usuario (CUIT/CUIL) en hash (SHA256). | String | No (Recomendado) |
| `first_name_hashed` | Nombre del usuario (hash). | String | No (Recomendado) |
| `last_name_hashed` | Apellido del usuario (hash). | String | No (Recomendado) |

> Normalizaci√≥n recomendada para hashing:
> - `email_hashed`: email en min√∫sculas y sin espacios (trim); hash SHA-256 en hexadecimal.
> - `phone_hashed`: tel√©fono en formato E.164 (ej.: +5491112345678), sin m√°scaras; hash SHA-256 en hexadecimal.
> - `social_id_hashed`: documento fiscal solo con d√≠gitos (sin puntos/guiones); hash SHA-256 en hexadecimal.
> - `first_name_hashed` / `last_name_hashed`: nombres normalizados (trim, sin espacios dobles); hash SHA-256 en hexadecimal.

#### **Estructura de los Art√≠culos del Pedido**

##### Campos del Objeto Item

| Campo | Descripci√≥n | Tipo | Obligatoriedad |
|-------|-----------|------|-----------------|
| `sku` | Identificaci√≥n √∫nica del SKU del producto | String | **Obligatorio** |
| `quantity` | Cantidad comprada del producto | Double | **Obligatorio** |
| `price` | Precio original del producto (precio "de") | Double | **Obligatorio** |
| `promotional_price` | Precio promocional del producto (precio "por") | Double | **Obligatorio** |
| `seller_id` | Identificaci√≥n del vendedor/seller | String | Opcional |
| `product_id` | Identificaci√≥n √∫nica del producto que engloba el SKU | String | Opcional |

##### ‚ö†Ô∏è Observaciones Importantes

1. **Valores unitarios**: Los campos `price` y `promotional_price` deben contener el valor **unitario** del producto, **no** multiplicado por la cantidad
2. **Campos obligatorios para medici√≥n**: Si `price` y `promotional_price` no se informan correctamente, la conversi√≥n **no podr√° ser medida**
3. **Formato monetario**: Los valores deben enviarse como n√∫meros decimales (ej: 1899.00)

#### **Ejemplos de Utilizaci√≥n**

##### Ejemplo de Art√≠culo Individual
```json
{
  "sku": "12221",
  "seller_id": "1234",
  "product_id": "4567",
  "quantity": 1,
  "price": 2000.00,
  "promotional_price": 1899.00
}
```

##### Ejemplo de Solicitud Completa

```http
POST https://events.newtail-media.newtail.com.br/v1/beacon/conversion HTTP/1.1
Accept: application/json
Content-Type: application/json
```

```json
{
  "channel": "ecommerce",
  "publisher_id": "xxx",
  "user_id": "6f92d1e9-00b6-4f8b-9645-faeab321e1cc",
  "session_id": "5898b8d1-c250-4bb5-931b-8b9d0ee7b499",
  "order_id": "123",
  "email_hashed": "xyz",
  "items": [
    {
      "sku": "12221",
      "seller_id": "1234",
      "product_id": "4567",
      "quantity": 1,
      "price": 2000.00,
      "promotional_price": 1899.00
    },
    {
      "sku": "12222",
      "seller_id": null,
      "product_id": "4568",
      "quantity": 2,
      "price": 500.00,
      "promotional_price": 400.00
    }
  ],
  "created_at": "2023-01-01T09:20:00Z"
}
```

**Nota**: En el ejemplo anterior, observe que:
- El primer art√≠culo tiene cantidad 1 con precio unitario de $2.000,00
- El segundo art√≠culo tiene cantidad 2 con precio unitario de $500,00 (no $1.000,00)

#### **Respuestas de la API**

##### ‚úÖ Respuesta Exitosa (HTTP 202)
```json
{
  "messages": [
    "conversion will be processed soon"
  ]
}
```

##### ‚ùå Respuesta de Error de Validaci√≥n (HTTP 422)
La API devuelve errores de validaci√≥n en un formato compatible con JSON Schema (similar a Ajv).

Ejemplo de respuesta con errores:
```json
[
  {
    "instancePath": "",
    "keyword": "required",
    "message": "must have required property 'user_id'",
    "params": {
      "missingProperty": "user_id"
    },
    "schemaPath": "#/required"
  },
  {
    "instancePath": "",
    "keyword": "required",
    "message": "must have required property 'order_id'",
    "params": {
      "missingProperty": "order_id"
    },
    "schemaPath": "#/required"
  },
  {
    "instancePath": "",
    "keyword": "required",
    "message": "must have required property 'publisher_id'",
    "params": {
      "missingProperty": "publisher_id"
    },
    "schemaPath": "#/required"
  },
  {
    "instancePath": "",
    "keyword": "required",
    "message": "must have required property 'items'",
    "params": {
      "missingProperty": "items"
    },
    "schemaPath": "#/required"
  },
  {
    "instancePath": "",
    "keyword": "required",
    "message": "must have required property 'created_at'",
    "params": {
      "missingProperty": "created_at"
    },
    "schemaPath": "#/required"
  }
]
```

#### **üéØ Regla de Match de Productos para Conversiones**

##### Importante: Correspondencia entre Producto y Campa√±a

Las conversiones **solo se computan** para campa√±as cuando ocurre un **match de producto**. Esto significa que:

- ‚úÖ **Conversi√≥n se mide**: Cuando el producto comprado por el usuario **pertenece** a la campa√±a en la que el usuario fue impactado
- ‚ùå **Conversi√≥n NO se mide**: Cuando el producto comprado **no pertenece** a la campa√±a en la que el usuario fue impactado

##### Ejemplo Pr√°ctico:

**Escenario 1 - Con Match (Conversi√≥n Computada)**
- Usuario visualiz√≥ anuncio de la Campa√±a A (productos: SKU-001, SKU-002, SKU-003)
- Usuario compr√≥ producto SKU-002
- ‚úÖ Conversi√≥n se atribuye a la Campa√±a A

**Escenario 2 - Sin Match (Conversi√≥n NO Computada)**
- Usuario visualiz√≥ anuncio de la Campa√±a B (productos: SKU-004, SKU-005)
- Usuario compr√≥ producto SKU-999
- ‚ùå Conversi√≥n NO se atribuye a la Campa√±a B

#### **Ejemplo de C√≥digo**

##### JavaScript (Browser)
```javascript
const enviarConversion = async (datosPedido) => {
  const payload = {
    channel: "ecommerce",
    publisher_id: "xxx",
    user_id: datosPedido.userId,
    session_id: datosPedido.sessionId,
    order_id: datosPedido.orderId,
    email_hashed: datosPedido.emailHash,
    items: datosPedido.items.map(item => ({
      sku: item.sku,
      seller_id: item.sellerId || null,
      product_id: item.productId || null,
      quantity: item.quantity,
      price: item.unitPrice,  // Valor unitario, no multiplicado
      promotional_price: item.unitPromotionalPrice  // Valor unitario, no multiplicado
    })),
    created_at: new Date().toISOString()
  };

  try {
    // Convierte los datos a JSON
    const blob = new Blob([JSON.stringify(payload)], {type: 'application/json'});

    // Env√≠a el evento de forma as√≠ncrona usando Beacon API
    if (navigator.sendBeacon) {
      const success = navigator.sendBeacon(
        'https://events.newtail-media.newtail.com.br/v1/beacon/conversion',
        blob
      );

      if (success) {
        console.log('Conversi√≥n enviada con √©xito');
      } else {
        console.error('Error al enviar conversi√≥n v√≠a Beacon API');
      }
    } else {
      // Fallback para navegadores que no soportan Beacon API
      const response = await fetch('https://events.newtail-media.newtail.com.br/v1/beacon/conversion', {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      if (response.status === 202) {
        console.log('Conversi√≥n enviada con √©xito');
      } else if (response.status === 422) {
        const errors = await response.json();
        console.error('Errores de validaci√≥n:', errors);
      }
    }
  } catch (error) {
    console.error('Error al enviar conversi√≥n:', error);
  }
};

// Ejemplo de uso
const pedido = {
  userId: "6f92d1e9-00b6-4f8b-9645-faeab321e1cc",
  sessionId: "5898b8d1-c250-4bb5-931b-8b9d0ee7b499",
  orderId: "123",
  emailHash: "xyz",
  items: [
    {
      sku: "12221",
      sellerId: "1234",
      productId: "4567",
      quantity: 1,
      unitPrice: 2000.00,
      unitPromotionalPrice: 1899.00
    }
  ]
};

enviarConversion(pedido);
```

#### **Reglas de Atribuci√≥n y Deduplicaci√≥n**

* **Ventana de Conversi√≥n:** Per√≠odo despu√©s de una interacci√≥n en el que una venta puede ser atribuida al anuncio.
    * **Clic (para `product`):** 14 d√≠as.
    * **Visualizaci√≥n (para `display`/`video`):** 14 d√≠as.
* **Deduplicaci√≥n de Eventos:** Para el mismo usuario y anuncio, los eventos se ignoran durante un per√≠odo.
    * **Impresiones:** 1 minuto.
    * **Clics:** 1 hora.
    * **Conversiones:** Idempotentes por `order_id` (reenv√≠os del mismo `order_id` dentro de 30 d√≠as se ignoran).
