## 4.3. Eventos

La notificación de eventos es **crucial** para la atribución y la medición.

#### Buenas Prácticas

* **Persistencia HTTP:** Utilice conexiones HTTP persistentes (`Connection: keep-alive` en el encabezado) para optimizar la performance.
* **Timeout:** Implemente un timeout de 500-600ms en las llamadas de consulta de anuncios para no perjudicar la experiencia del usuario.

#### **Identificación de Usuario y Sesión**

* **`session_id`:** ID de la sesión del usuario. Obligatorio en todos los eventos. Debe ser consistente durante la navegación. El session_id debe ser único por usuario y tener una vida útil de al menos 14 días debido a la ventana de conversión. Lo ideal es que el session_id no expire.
* **`user_id`:** ID único del cliente en la plataforma, consistente entre canales. Obligatorio en el evento de conversión. El user_id debe ser el mismo entre múltiples entornos como app, sitio web y tienda física.

#### **Notificación de Impresión, Visualización y Clic**

Envíe una solicitud `POST` a la respectiva URL de evento (`impression_url`, `view_url`, `click_url`) proporcionada en la consulta de anuncios, con un cuerpo JSON que contenga `user_id` y `session_id`.

* **Content-Type:** Todas las solicitudes deben incluir el encabezado `Content-Type: application/json`
* **Método Obligatorio (Navegador):** Es **obligatorio** usar `navigator.sendBeacon()` para garantizar el envío asíncrono sin bloquear la navegación y evitar la pérdida de eventos cuando el usuario navega a otra página o cierra el navegador.
* **Respuesta Exitosa:** `HTTP 202 Accepted`.

**Ejemplo de envío de evento usando Beacon API:**

```javascript
// Función para enviar evento de impresión
function sendImpressionEvent(impressionUrl, userId, sessionId) {
    // Datos del evento
    const eventData = {
        user_id: userId,
        session_id: sessionId
    };

    // Verifica si el navegador soporta la Beacon API
    if (navigator.sendBeacon) {
        // Convierte los datos a JSON
        const blob = new Blob([JSON.stringify(eventData)], {type: 'application/json'});

        // Envía el evento de forma asíncrona
        const success = navigator.sendBeacon(impressionUrl, blob);

        if (!success) {
            console.error('Error al enviar evento vía Beacon API');
            // Implementar fallback si es necesario
        }
    } else {
        // Fallback para navegadores que no soportan Beacon API
        const xhr = new XMLHttpRequest();
        xhr.open('POST', impressionUrl, true); // true para asíncrono
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify(eventData));
    }
}

// Ejemplo de uso
sendImpressionEvent(
    'https://events.newtail-media.newtail.com.br/v1/beacon/impression/123456',
    'user-123',
    'session-456'
);
```

> **Importante:** El uso de la Beacon API es obligatorio para garantizar que los eventos se envíen incluso cuando el usuario navega a otra página o cierra el navegador. Esto evita la pérdida de eventos y asegura una medición más precisa.

#### **Notificación de Conversión**

Cuando una compra es finalizada, envíe los datos del pedido.

* **Endpoint:** `POST https://events.newtail-media.newtail.com.br/v1/beacon/conversion`
* **Content-Type:** Todas las solicitudes deben incluir el encabezado `Content-Type: application/json`
* **Cuerpo de la Solicitud:** El objeto debe contener los datos del pedido. El precio del artículo no debe ser multiplicado por la cantidad.

| Campo del Pedido | Descrição | Tipo | ¿Obligatorio? |
| :--- | :--- | :--- | :--- |
| `publisher_id` | ID del publisher. | String | Sí |
| `user_id` | ID del usuario que realizó la compra. | String | Sí |
| `session_id` | ID de la sesión de la compra. | String | Sí |
| `order_id` | ID del pedido. | String | Sí |
| `created_at` | Fecha/hora del pedido (ISO 8601 en UTC). | String | Sí |
| `items` | Lista de artículos del pedido. | Array[Item] | Sí |
| `gender` | Indica el género del cliente. F: para femenino, M: para masculino, O: para otros, null: para no identificados. | String | No (Recomendado) |
| `uf` | Indica el estado de la compra del pedido. | String | No (Recomendado) |
| `city` | Indica el nombre de la ciudad donde el cliente realizó la compra. | String | No (Recomendado) |
| `is_company` | Indica si la venta fue realizada a una persona jurídica o física. | Boolean | No (Recomendado) |
| `email_hashed` | E-mail del usuario en formato hash (SHA256). | String | Sí |
| `phone_hashed`| Teléfono del usuario en hash (SHA256). | String | No (Recomendado) |
| `social_id_hashed`| ID social/fiscal del usuario (CUIT/CUIL) en hash (SHA256). | String | No (Recomendado) |
| `first_name_hashed` | Identificación del Nombre del usuario en formato hash. | String | No (Recomendado) |
| `last_name_hashed` | Identificación del Apellido del usuario en formato hash. | String | No (Recomendado) |

#### **Reglas de Atribución y Deduplicación**

* **Ventana de Conversión:** Período después de una interacción en el que una venta puede ser atribuida al anuncio.
    * **Clic (para `product`):** 14 días.
    * **Visualización (para `display`/`video`):** 14 días.
* **Deduplicación de Eventos:** Para el mismo usuario y anuncio, los eventos se ignoran durante un período.
    * **Impresiones:** 1 minuto.
    * **Clics:** 1 hora.
    * **Conversiones:** No se deduplican (excepto si el mismo `order_id` se envía nuevamente dentro de los 30 días).
